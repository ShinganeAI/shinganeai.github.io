<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Intranet</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="description" content="Company Internal Knowledge Base">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/docsify/lib/themes/vue.css">
  <style>
    /* Basic styling for content and font */
    .content {
      border-radius: 0.75rem; /* Equivalent to Tailwind's rounded-xl */
      padding: 1.5rem; /* Equivalent to Tailwind's p-6 */
    }
    body {
        font-family: 'Inter', sans-serif; /* Recommended font */
    }
    /* Styles for the loading screen/message */
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff; /* White background */
      display: flex;
      flex-direction: column; /* Stack elements vertically */
      justify-content: center;
      align-items: center;
      font-size: 1.5rem;
      color: #333; /* Dark grey text */
      z-index: 9999; /* Ensure it's on top of everything */
      text-align: center;
      padding: 1rem;
    }
    #loading button {
      padding: 0.75rem 1.5rem;
      margin-top: 1.5rem;
      border-radius: 0.5rem;
      background-color: #4CAF50; /* Green for login, Red for retry */
      color: white;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.3s ease;
    }
    #loading button:hover {
        background-color: #45a049;
    }
    #loading .error-button {
        background-color: #f44336;
    }
    #loading .error-button:hover {
        background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <!-- Loading screen shown initially, hidden upon successful authentication -->
  <div id="loading">Loading intranet...</div>

  <!-- Docsify app content, hidden until authenticated -->
  <div id="app" style="display: none;"></div>

  <!-- Docsify configuration object -->
  <!-- This must be defined before Docsify is initialized by Docsify.init() -->
  <script>
    window.$docsify = {
      name: 'Shingane Intranet', /* Display name for your intranet */
      repo: 'ShinganeAI/company-intranet', /* Link to your GitHub repo (optional) */
      loadSidebar: true, /* Enable sidebar loading (from _sidebar.md) */
      auto2top: true, /* Scroll to top on page change */
      search: {
        maxAge: 86400000, /* Cache search results for 1 day */
        placeholder: 'Search intranet',
        noData: 'No results found!',
      },
      // You can add more Docsify configuration options here
      // For example: themeColor, coverpage, homepage, etc.
    };
  </script>

  <!-- Firebase SDK and Initialization (uses type="module" for ES module imports) -->
  <!-- This script initializes Firebase and exposes global variables for use by other scripts -->
  <!-- <script type="module">
    // Import necessary Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables to expose Firebase instances and user ID
    // These will be set after Firebase successfully initializes and authenticates
    window.firebaseApp = null;
    window.firebaseDb = null;
    window.firebaseAuth = null;
    window.firebaseUserId = null;

    // Access global variables provided by the Canvas environment
    // These values are injected by the Canvas platform at runtime
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null; // Fixed typo here

    /**
     * Initializes Firebase and authenticates the user.
     * Sets global Firebase instances (app, db, auth, userId).
     */
    async function initializeFirebase() {
      // Check if firebaseConfig is provided before attempting to initialize
      if (Object.keys(firebaseConfig).length > 0) {
        try {
          // Initialize Firebase app
          window.firebaseApp = initializeApp(firebaseConfig);
          window.firebaseDb = getFirestore(window.firebaseApp);
          window.firebaseAuth = getAuth(window.firebaseApp);

          const auth = window.firebaseAuth;
          const db = window.firebaseDb;

          /**
           * Handles signing in the Firebase user, either with a custom token or anonymously.
           */
          const signInFirebaseUser = async () => {
            try {
              if (initialAuthToken) {
                // Sign in using the provided custom token (for authenticated Canvas users)
                await signInWithCustomToken(auth, initialAuthToken);
                console.log('Firebase: Signed in with custom token.');
              } else {
                // Sign in anonymously if no custom token is available
                await signInAnonymously(auth);
                console.log('Firebase: Signed in anonymously.');
              }
              // Set the global Firebase user ID
              window.firebaseUserId = auth.currentUser?.uid || crypto.randomUUID();
              console.log('Firebase: Current user ID:', window.firebaseUserId);

              // --- Optional: Example of listening to a Firestore collection ---
              // Uncomment and adapt this block if you need real-time data from Firestore.
              /*
              if (db && window.firebaseUserId) {
                const announcementsRef = collection(db, `artifacts/${appId}/public/data/announcements`);
                onSnapshot(announcementsRef, (snapshot) => {
                  const announcements = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  console.log("Firebase: Real-time announcements:", announcements);
                  // Here, you would update your intranet's UI with the fetched announcements.
                  // For example, inject them into a specific HTML element or Docsify page.
                }, (error) => {
                  console.error("Firebase: Error fetching announcements:", error);
                });
              }
              */
              // -----------------------------------------------------------------

            } catch (error) {
              console.error('Firebase: Authentication failed:', error);
            }
          };

          // Listen for Firebase authentication state changes
          // If no user is currently logged in, attempt to sign them in
          onAuthStateChanged(auth, (user) => {
            if (!user) {
              signInFirebaseUser();
            } else {
              window.firebaseUserId = user.uid;
              console.log('Firebase: User already logged in:', window.firebaseUserId);
            }
          });

        } catch (error) {
          console.error('Firebase: Initialization failed:', error);
        }
      } else {
        console.warn('Firebase: Config not available. Skipping initialization.');
      }
    }

    // Call the Firebase initialization function immediately when this module script executes
    initializeFirebase();
  </script> -->

  <!-- Main Authentication and Docsify Initialization Script -->
  <!-- This script handles the IdP authentication and then initializes Docsify -->
  <!-- <script>
    // --- Placeholder for your Identity Provider (IdP) SDK ---
    // IMPORTANT: You MUST replace this placeholder with the actual JavaScript SDK
    // provided by your chosen Identity Provider (e.g., Lovable, Auth0, Okta).
    // This example simulates basic authentication checks using localStorage.
    const LovableAuthSDK = {
      /**
       * Simulates IdP SDK initialization.
       * @param {object} config - Configuration for the IdP.
       */
      init: async (config) => {
        console.log('LovableAuthSDK initialized with:', config);
        // Simulate an asynchronous initialization process
        return new Promise(resolve => setTimeout(resolve, 500));
      },
      /**
       * Simulates checking if a user is authenticated.
       * In a real IdP SDK, this would check for valid tokens/sessions.
       */
      isAuthenticated: () => {
        return localStorage.getItem('isLoggedIn') === 'true'; // Simple check
      },
      /**
       * Simulates initiating the login process.
       * In a real IdP SDK, this would redirect the user to the IdP's login page.
       */
      login: () => {
        console.log('Redirecting to login...');
        localStorage.setItem('isLoggedIn', 'true'); // Simulate successful login
        window.location.reload(); // Reload the page to re-trigger authentication flow
      },
      /**
       * Simulates initiating the logout process.
       * In a real IdP SDK, this would clear tokens/sessions and redirect.
       */
      logout: () => {
        console.log('Logging out...');
        localStorage.removeItem('isLoggedIn'); // Clear simulated login state
        // Redirect to the base URL to ensure clean unauthenticated state
        window.location.href = window.location.origin + window.location.pathname;
      },
      /**
       * Simulates getting user information.
       */
      getUser: async () => {
        if (LovableAuthSDK.isAuthenticated()) {
          return { name: 'Logged In User', email: 'user@example.com' }; // Placeholder user info
        }
        return null;
      }
    };

    // Configuration for your Identity Provider
    // IMPORTANT: Replace these with your actual IdP domain and client ID
    const AUTH_CONFIG = {
      domain: 'your-lovable-domain.com', // e.g., 'dev-12345.auth0.com'
      clientId: 'your-lovable-client-id', // e.g., 'abcdef12345...'
      // The redirect URI is where the IdP sends the user back after login
      redirectUri: window.location.origin + window.location.pathname,
    };

    /**
     * Main function to handle authentication and initialize the intranet application.
     * This runs once the DOM is fully loaded.
     */
    async function authenticateAndInitializeApp() {
      const loadingScreen = document.getElementById('loading');
      const appDiv = document.getElementById('app');

      try {
        // Step 1: Initialize and authenticate with the Identity Provider (IdP)
        await LovableAuthSDK.init(AUTH_CONFIG);

        if (await LovableAuthSDK.isAuthenticated()) {
          console.log('User is authenticated with IdP.');

          // If Firebase is also needed, you might want to ensure Firebase user is ready here
          // before completely showing the UI, especially if content depends on Firebase data.
          // Example:
          // if (window.firebaseApp && !window.firebaseUserId) {
          //   console.log("Waiting for Firebase user to be ready before full app display...");
          //   // This is a simple wait; for complex scenarios, a more robust state management is needed.
          //   await new Promise(resolve => {
          //     const unsubscribe = window.firebaseAuth.onAuthStateChanged(user => {
          //       if (user) {
          //         unsubscribe(); // Stop listening once user is found
          //         resolve();
          //       }
          //     });
          //   });
          //   console.log("Firebase user is ready.");
          // }

          // Step 2: Hide the loading screen and display the main intranet content
          loadingScreen.style.display = 'none';
          appDiv.style.display = 'block';

          // Step 3: Initialize Docsify (must be done AFTER authentication)
          // window.$docsify object must be defined before this call
          if (typeof Docsify !== 'undefined') {
            Docsify.init(window.$docsify);
          } else {
            console.error('Docsify is not loaded. Ensure docsify.min.js is included.');
          }


          // Optional: Display user information or a logout button
          const user = await LovableAuthSDK.getUser();
          if (user) {
            console.log('Welcome,', user.name);
            // You could dynamically add a logout button to your Docsify sidebar or header here.
            // For example: appDiv.insertAdjacentHTML('afterbegin', `<button onclick="LovableAuthSDK.logout()">Logout</button>`);
          }

        } else {
          // If user is not authenticated, display a login prompt/button
          console.log('User not authenticated with IdP, displaying login option.');
          loadingScreen.innerHTML = `
            Please log in to access the Company Intranet.
            <button onclick="LovableAuthSDK.login()">Login</button>
          `;
          // In a real IdP setup, LovableAuthSDK.login() would usually trigger an immediate redirect.
          // The button here is for demonstration/simulated login.
        }
      } catch (error) {
        // Handle any errors during authentication or initialization
        console.error('App initialization failed:', error);
        loadingScreen.innerHTML = `
          Intranet initialization failed: ${error.message}. Please try again.
          <button onclick="LovableAuthSDK.login()" class="error-button">Retry Login</button>
        `;
      }
    }

    // Attach the main initialization function to the DOMContentLoaded event
    // This ensures the HTML is fully parsed before script execution
    document.addEventListener('DOMContentLoaded', authenticateAndInitializeApp);
  </script> -->

  <!-- Docsify Library Scripts -->
  <!-- These must be included AFTER window.$docsify is defined for Docsify to pick it up -->
  <script src="//cdn.jsdelivr.net/npm/docsify/lib/docsify.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/docsify/lib/plugins/search.min.js"></script>
  <!-- Add other Docsify plugins here if needed (e.g., emoji, zoom-image, etc.) -->
</body>
</html>


